# 共识算法


## 介绍
xchain改进了主流的联盟链共识算法，采用POA+PBFT和POA+Raft两种共识。
整个过程包括2大阶段：  

验证人选举：通过相关选举规则选出一个验证者集合；
共识出块：验证者集合按照约定的协议规则进行区块生产；

**验证人validator**

验证者负责在区块链中提交新块。这些验证者通过广播 *votes* 参与共识协议，其中包含由每个验证者的私钥签名。
验证者在共识协议中可能具有不同的投票“权重”。xchain并不关注验证者数目的三分之一或三分之二， 而是关注总投票权的比例。而且，这个比例可能不是在各个验证者中均匀分布的。

**如何创建验证者**

有两种方法可以成为验证者。

1.  创世区块创立时预先建立
2. 通过网络管理员发起提案并进行投票  提案生效后通过 `EndBlock`  将应用端验证人的变更响应到共识层(可新增、可删除、可修改权重)



##  PBFT

**共识逻辑**

![](picture/Consensuslogic2.png)

+2/3 是 “大于2/3”的缩写，validator轮流提出区块并对其进行投票。 

当一个区块提交失败时，协议将进入到下一**round（轮）** ，新的验证者将为该高度提出一个新的区块。 
```
提交失败的原因：
1.投票阶段赞成权重不足
2.出块节点故障或异常
```

成功提交一个块需要两个阶段的投票，分别是**pre-vote（预投票）** 和**pre-commit（预提交)** 。 当同一轮中预提交同一个区块时，投票超过2/3的权重，区块就会被提交到区块链中。

> 验证者可能由于多种原因未能提交区块： 当前的区块提交者可能离线，或者网络可能拥堵。就会确认跳过这个验证者。在投票进入下一轮之前，验证者们会等待一小段时间从提交者处收到完整的区块。

**交易流程图**

  
![](picture/flowchart1.png)
![](picture/flowchart2.png)
  
 
**交易的处理逻辑**

![](picture/Processinglogic2.png)

>区块的执行逻辑
>
>beginBlock 
>
>deliverTxs 
>
>  ...
>  
>endBlock 
>
>commit

**验证节点间轮值**

poa+pbft的出块节点有一个固定的顺序，验证节点会一直检查是否轮到自己出块了。
```
PBFT是一种状态机副本复制算法，所有的副本在一个视图（view）轮换的过程中操作，
出块节点通过视图编号以及节点数集合来确定，即：出块节点 p = v mod |R|。
v：视图编号，|R|节点个数，p：出块节点编号。
```

## RAFT

**交易流程**
![](picture/flowchart4.png)
leader选举出来后，所有日志都必须首先提交至 leader 节点，leader 将此条目复制给所有的节点。

当大多数节点记录此条目之后，leader 节点认定此条目有效，将此条目设定为已提交并存储于本地磁盘。

leader 通知所有节点提交这一日志条目并存储于各自的磁盘内。

**验证节点间轮值**

leader节点会一直向其他节点发送“心跳”，表明自己还在任期

当节点没有收到leader的心跳时 : 采取验证人节点间竞争的方式

每个validator发起选举然后投票给自己，并向集群其他服务器验证人发送投票请求。有超过1/2的验证人返回同一个leader后确认

当leader超时或不在线时，重新选举leader

